@using DotNetNuke.Entities.Users
@using DotNetNuke.Entities.Controllers
@using DotNetNuke.Common
@using System
@{
   bool isEdit = Model.Context.IsEditable;
    // Read HostSettings directly (no local function)
    var supportEmailRaw = HostController.Instance.GetString("Upendo.Support.Email", string.Empty);

    var supportEmail = (string.IsNullOrEmpty(supportEmailRaw) ? string.Empty : supportEmailRaw);

    // Current user info (avoid null-conditional)
    var user = (Dnn != null && Dnn.User != null) ? Dnn.User : UserController.Instance.GetCurrentUserInfo();
    var displayName = (user != null && !string.IsNullOrEmpty(user.FirstName))
        ? user.FirstName
        : (user != null ? user.Username : "there");

    // Last visit determination
    DateTime lastVisit = DateTime.MinValue;
    try
    {
        if (user != null)
        {
            var lastLoginDateProp = user.GetType().GetProperty("LastLoginDate");
            if (lastLoginDateProp != null)
            {
                object valObj = lastLoginDateProp.GetValue(user, null);
                if (valObj is DateTime)
                {
                    DateTime valDt = (DateTime)valObj;
                    if (valDt != DateTime.MinValue) { lastVisit = valDt; }
                }
            }
            if (lastVisit == DateTime.MinValue && user.Membership.LastLoginDate != DateTime.MinValue) { lastVisit = user.Membership.LastLoginDate; }
            if (lastVisit == DateTime.MinValue && user.Membership.LastActivityDate != DateTime.MinValue) { lastVisit = user.Membership.LastActivityDate; }
        }
    }
    catch { }

    string lastVisitText;
    if (lastVisit != DateTime.MinValue)
    {
        lastVisitText = lastVisit.ToLocalTime().ToString("MMM d, yyyy h:mm tt");
    }
    else
    {
        lastVisitText = "--";
    }

    var hdrId = "growth-header-" + (user != null ? user.UserID.ToString() : DateTime.UtcNow.Ticks.ToString());
}

<section class="mb-3 p-3" aria-labelledby="@hdrId">
  <div class="card shadow-sm border-0">
    <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
      <div class="flex-grow-1">
        <h1 id="@hdrId" class="h5 mb-1 heading-primary">
          <i class="fas fa-heart me-2 text-danger" aria-hidden="true"></i>
          Welcome back, <span class="fw-bold">@displayName</span>
        </h1>
        <p class="mb-0 text-muted">
          <i class="far fa-clock me-2" aria-hidden="true"></i>
          Last visit: <span aria-live="polite">@lastVisitText</span>
        </p>
      </div>

      <div class="ms-md-auto d-flex flex-wrap gap-2" role="group" aria-label="Support quick links">

        <a href="mailto:?subject=Join%20Me%20at%20SCBNG!&body=Hello%2C%0D%0A%0D%0AI'd%20like%20to%20invite%20you%20to%20check%20out%20the%20San%20Carlos%20Business%20Networking%20Group%20(SCBNG).%20We%20meet%20every%20other%20Monday%20from%208%3A15%20to%209%3A30%20AM%20on%20Zoom%2C%20and%20it's%20a%20great%20way%20to%20connect%20with%20local%20business%20owners%20and%20professionals.%0D%0A%0D%0AHere's%20the%20link%20to%20see%20who%20you'll%20be%20networking%20with%3A%20https%3A%2F%2Fscbng.org%2FMembers%0D%0A%0D%0AHope%20you%20can%20make%20it!" 
          class="btn btn-sm btn-primary track-recruit" title="One-click and you can invite someone to our group!" aria-label="One-click and you can invite someone to our group!" data-bs-toggle="tooltip" data-bs-placement="top">
          <i class="fas fa-envelope me-2" aria-hidden="true"></i>
          Invite Someone
        </a>

        @if(!string.IsNullOrEmpty(Model.PresentationSignUp))
        {
        <a class="btn btn-sm btn-primary track-speak" 
           href="@Model.PresentationSignUp" 
           target="_blank" rel="noopener noreferrer" 
           aria-label="Sign up for a presentation slow"
           data-bs-toggle="tooltip" data-bs-placement="top"
           title="Sign up to speak at a future meeting.">
          <i class="fas fa-chalkboard-teacher me-2" aria-hidden="true"></i>Want to Speak?
        </a>
        }

        @if(!string.IsNullOrEmpty(Model.MemberOnlineBinder))
        {
        <a class="btn btn-sm btn-secondary d-none d-sm-block" 
           href="@Model.MemberOnlineBinder" 
           target="_blank" rel="noopener noreferrer" 
           aria-label="Business contact details for all current/former SCBNG members"
           data-bs-toggle="tooltip" data-bs-placement="top"
           title="Business contact details for all current/former SCBNG members">
          <i class="far fa-file-excel me-2" aria-hidden="true"></i>Member Binder
        </a>
        }

        @if (!(string.IsNullOrEmpty(supportEmail) || supportEmail.Trim().Length == 0))
        {
          <a class="btn btn-sm btn-secondary" 
             href="mailto:@supportEmail" 
             aria-label="Get support from @supportEmail"
             data-bs-toggle="tooltip" data-bs-placement="top"
             title="Email our support team directly for help.">
            <i class="far fa-envelope me-2" aria-hidden="true"></i>Need Help?
          </a>
        }
        else
        {
          <button type="button" class="btn btn-sm btn-secondary" disabled="disabled" aria-disabled="true"
                  data-bs-toggle="tooltip" data-bs-placement="top"
                  title="Support email is not configured. Please contact your administrator.">
            <i class="far fa-envelope me-2" aria-hidden="true"></i>Support email not configured
          </button>
        }

        <a class="btn btn-sm btn-secondary d-none d-sm-block" 
           href="https://upendoventures.wetransfer.com/" 
           target="_blank" rel="noopener noreferrer" 
           aria-label="Send files via WeTransfer"
           data-bs-toggle="tooltip" data-bs-placement="top"
           title="Securely send us files through WeTransfer.">
          <i class="fas fa-file-upload me-2" aria-hidden="true"></i>Send Files
        </a>
      </div>
    </div>
  </div>

  @if (Model.NextMeeting != null)
  {
    var meetingCount = 0;
    <section class="bg-light p-4 rounded shadow-sm mb-4 mt-5" aria-labelledby="next-meeting-title">
      <div class="row">
    @foreach(var meeting in Model.NextMeeting)
    {
      meetingCount++;
      DateTime parsedStart = DateTime.MinValue;
      DateTime.TryParse(meeting.StartDate as string, out parsedStart);
      DateTime parsedEnd = DateTime.MaxValue;
      DateTime.TryParse(meeting.EndDate as string, out parsedEnd);

      <div class="col @if(meetingCount > 1){<text>d-none d-sm-block</text>}">
        <h2 id="next-meeting-title" class="heading-primary h4 fw-bold mb-3">
          <i class="fas fa-calendar-day me-2 text-primary" aria-hidden="true"></i>
          @(meeting.MeetingTitle + " - " + parsedStart.ToString("MM/dd"))
        </h2>

        <p class="text-muted mb-2">
          <i class="fas fa-clock me-2 text-primary" aria-hidden="true"></i>
          <strong>When:</strong> 
          @parsedStart.ToString("ddd, MMM d, yyyy")
          from @parsedStart.ToString("h:mm tt") to @parsedEnd.ToString("h:mm tt")
        </p>

        @if (!string.IsNullOrEmpty(meeting.ZoomLink))
        {
          <p class="text-muted mb-2"> 
            <i class="fas fa-video me-2 text-primary" aria-hidden="true"></i> 
            <strong>Zoom:</strong> <a href="@meeting.ZoomLink" target="_blank" rel="noopener noreferrer"> Join Zoom Meeting</a> (<em>please connect early!</em>) 
          </p>
        }

        @if (!string.IsNullOrEmpty(meeting.LocationName) && !string.IsNullOrEmpty(meeting.Address) && !string.IsNullOrEmpty(meeting.MapUrl))
        {
          <p class="text-muted mb-2">
            <i class="fas fa-map-marker-alt me-2 text-primary" aria-hidden="true"></i>
            <strong>In-Person:</strong> @meeting.LocationName <a href="@meeting.MapUrl" target="_blank" rel="noopener noreferrer" class="">@meeting.Address</a>
          </p>
        }

        @if(meeting.Speakers != null){ 
          var speakerCount = 0;

          <p class="fw-bold d-line-block mb-1">Speaker(s):</p>
          foreach(var speaker in meeting.Speakers){
            var isPromo = (speaker.SpeakerSlot == "promo");
            var isEducation = (speaker.SpeakerSlot == "educator");
            var educationTitle = string.Concat(speaker.SpeakerName, " will be teaching us something!");
            var promoTitle = string.Concat(speaker.SpeakerName, " will show us how to refer business to them!");

            <a href="@speaker.SpeakerPage" class="btn btn-sm btn-outline btn-quaternary d-line-block my-2" 
              @if(isEducation){ <text> title="@educationTitle" aria-label="@educationTitle"</text> }
              @if(isPromo){ <text> title="@promoTitle" aria-label="@promoTitle"</text> } data-bs-toggle="tooltip" data-bs-placement="top">
            @if(isEducation){
              <i class="fas fa-chalkboard-teacher me-2" aria-hidden="true"></i>
            }
            @if(isPromo){
              <i class="fas fa-bullhorn me-2" aria-hidden="true"></i>
            }
            @speaker.SpeakerName (@speaker.SpeakerSlot)
            </a> 
            
            speakerCount++;
          }

          if (speakerCount < 2){
            <a href="@BuildSignUpLink(Model.PresentationSignUp, parsedStart)" 
              class="btn btn-sm btn-outline btn-tertiary d-line-block track-speak" target="_blank" rel="noreferrer noopener" 
              title="We're excited to see your presentation... Sign-up!" aria-label="We're excited to see your presentation... Sign-up!" 
              data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-file-signature me-2" aria-hidden="true"></i>Sign Up to Speak!</a>
          }
        }
        </div>
      }
      </div>
    </section>
  }
  else
  {
    <div class="alert alert-info mt-3 mb-0" role="alert">
      <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
      Next meeting information is not yet available. Please check back later.
    </div>
  }

  <hr class="my-4" />
</section>
@*
@ObjectInfo.Print(Model)
*@
@functions {
    /// <summary>
    /// Builds a presentation sign-up link with a text fragment that highlights the given date.
    /// </summary>
    /// <param name="baseUrl">The base PresentationSignUp URL</param>
    /// <param name="date">The DateTime of the meeting start</param>
    /// <returns>URL with text fragment</returns>
    public static string BuildSignUpLink(string baseUrl, DateTime date)
    {
        if (string.IsNullOrEmpty(baseUrl) || date == DateTime.MinValue) return baseUrl;

        // Format exactly as it appears on the target page: MM/dd/yyyy
        var highlightText = Uri.EscapeDataString(date.ToString("MM/dd/yyyy")); 
        return baseUrl + "#:~:text=" + highlightText;
    }
}